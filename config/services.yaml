# config/services.yaml
parameters:
  stripe_secret_key: '%env(STRIPE_SECRET_KEY)%'
  stripe_webhook_secret: '%env(STRIPE_WEBHOOK_SECRET)%'
  google_recaptcha_site_key: '%env(GOOGLE_RECAPTCHA_SITE_KEY)%'
  google_recaptcha_secret_key: '%env(GOOGLE_RECAPTCHA_SECRET_KEY)%'
  # Contact form email configuration
  contact_admin_email: '%env(CONTACT_ADMIN_EMAIL)%'
  contact_secondary_email: '%env(CONTACT_SECONDARY_EMAIL)%'
  no_reply_email: '%env(NO_REPLY_EMAIL)%'
  frontend_url: '%env(FRONTEND_URL)%'

services:
  # default configuration for services in *this* file
  _defaults:
    autowire: true # Automatically injects dependencies in your services.
    autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.
    public: false

  App\:
    resource: "../src/"
    exclude:
      - "../src/DependencyInjection/"
      - "../src/Entity/"
      - "../src/Kernel.php"
  App\Controller\:
    resource: '../src/Controller'
    tags: [ 'controller.service_arguments' ]
    public: false

  App\State\UserPasswordHasher:
    bind:
      $processor: "@api_platform.doctrine.orm.state.persist_processor"

  App\Doctrine\CurrentUserExtension:
    tags:
      - { name: "api_platform.doctrine.orm.query_extension.collection" }
      - { name: "api_platform.doctrine.orm.query_extension.item" }
  App\EventListener\JWTCreatedListener:
    tags:
      - {
          name: "kernel.event_listener",
          event: "lexik_jwt_authentication.on_jwt_created",
          method: "onJWTCreated",
        }

  # Configuration des stratégies
  App\Service\Rapport\Strategy\:
    resource: '../src/Service/Rapport/Strategy'
    tags: ['rapport.strategy'] # Taguer les stratégies pour les injecter automatiquement

  # Configuration de RapportManager
  App\Service\Rapport\RapportManager:
    arguments:
      $strategies: !tagged_iterator 'rapport.strategy' # Injecter toutes les stratégies avec ce tag

  # Configuration du service Stripe
  App\Service\StripeService:
    arguments:
      $stripeSecretKey: '%stripe_secret_key%'
      $stripeWebhookSecret: '%stripe_webhook_secret%'

  # Authentication Success Listener
  App\EventListener\AuthenticationSuccessListener:
    arguments:
      $tokenTtl: 28800  # 8 hours (28800 seconds)
    tags:
      - {
          name: "kernel.event_listener",
          event: "lexik_jwt_authentication.on_authentication_success",
          method: "onAuthenticationSuccess",
        }

  # Authentication Failure Listener
  App\EventListener\AuthenticationFailureListener:
    tags:
      - {
          name: "kernel.event_listener",
          event: "lexik_jwt_authentication.on_authentication_failure",
          method: "onAuthenticationFailure",
        }

